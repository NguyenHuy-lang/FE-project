<!DOCTYPE html>
<html lang="en">

  <head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
      crossorigin="anonymous"></script>
    <meta charset="UTF-8"/>
    <meta content="IE=edge" http-equiv="X-UA-Compatible"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <link href="/css/product_list.css" rel="stylesheet"/>
    <link href="/css/product_add.css" rel="stylesheet"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  </head>

  <body>
    <div inser></div>
    <div class="search-box">
      <h1 >Search product</h1>
      <p>Enter syntax:</p>
      <input type="text" id="search-box"><br>
      <select style="max-width:90%;" id="search-results" size="5"></select>
    </div>
    
    <script>
      $(document).ready(function() {
        $('#search-box').on('keyup', function() {
          var query = $(this).val();
          var url = 'http://127.0.0.1:8080/api/v1/products/search/' + query;
          $.get(url, function(data) {
            var results = $('#search-results');
            results.empty();
            $.each(data, function() {
              results.append($('<option>').text(this.name).val(this.id));
            });
          });
        });
        $('#search-results').on('click', 'option', function() {
          var resultId = $(this).val();
          const form = document.querySelector('#update-form');
          const prdIdField = document.querySelector('#prdid');
          const prdNameField = document.querySelector('#prdname');
          const descriptionField = document.querySelector('#description');
          const img = document.querySelector('.img');
          const priceField = document.querySelector('#price');
          const categorySelect = document.querySelector('#category-select');

          // Fetch the product data from the server
          fetch(`http://127.0.0.1:8080/api/v1/admin/products/${resultId}`)
            .then(response => response.json())
            .then(product => {
              // Set the values of the form fields to the corresponding data of the product
              prdIdField.value = product.id;
              prdNameField.value = product.name;
              descriptionField.value = product.description;
              img.src = product.imgPath;
              priceField.value = product.price;
              categorySelect.value = product.cate.id;
            })
            .catch(error => console.error(error));
        });
      });
      

    </script>
    <script>
      function deleteItem(itemId) {
        fetch(`http://localhost:8080/api/v1/admin/products/${itemId}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json'
            // add any other necessary headers, such as authentication tokens
          }
        })
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          // handle successful response, such as removing the item from the UI
          const itemElement = document.querySelector(`li[data-item-id="${itemId}"]`);
          itemElement.remove();
        })
        .catch(error => {
          console.error('Error:', error);
          // handle error scenario, such as displaying an error message
        });
      }
    </script> 
    <br>
    <script>
      fetch("http://127.0.0.1:8080/api/v1/admin/products").then(
        res => {
          res.json().then(
            data => {
              console.log(data);
              if (data.length > 0) {
                var temp = "";
                data.forEach((itemData) => {
                  temp += `<tr>
                    <td>${itemData.id}</td>
                    <td><img width="50dp" height="50dp" src="${itemData.imgPath}" alt="Image placeholder" class="img-fluid"></td>
                    <td>${itemData.name}</td>
                    <td>${itemData.price}</td>
                    <td>${itemData.cate.name}</td>
                    <td>
                      <div class="Button">
                        <button onclick="deleteItem(${itemData.id})" id="Bt" type="button">
                          <a href="/html/admin/product_list.html" class="Bt_text">Delete</a>
                        </button>
                        <button onclick="populateFormWithApiData(${itemData.id})" id="Bt" class="detailbtn" type="button">
                          <a class="Bt_text">Update</a>
                        </button>
                      </div>
                    </td>
                  </tr>`;

                });
                document.getElementById('data').innerHTML = temp;
              }
            }
          )
        }
      )
      
      // const imgTag = document.querySelector("img"); //get the img tag element
      // const srcValue = imgTag.getAttribute('src');
      
    </script>
    <script>
      function populateFormWithApiData(id) {
        // Replace URL with your API endpoint and ID parameter name
        const form = document.querySelector('#update-form');
        const prdIdField = document.querySelector('#prdid');
        const prdNameField = document.querySelector('#prdname');
        const descriptionField = document.querySelector('#description');
        const img = document.querySelector('.img');
        const priceField = document.querySelector('#price');
        const categorySelect = document.querySelector('#category-select');

        // Fetch the product data from the server
        fetch(`http://127.0.0.1:8080/api/v1/admin/products/${id}`)
          .then(response => response.json())
          .then(product => {
            // Set the values of the form fields to the corresponding data of the product
            prdIdField.value = product.id;
            prdNameField.value = product.name;
            descriptionField.value = product.description;
            img.src = product.imgPath;
            priceField.value = product.price;
            categorySelect.value = product.cate.id;
          })
          .catch(error => console.error(error));
      }
    </script>
    <script type="text/javascript">
      fetch('http://localhost:8080/api/v1/categories')
      .then(response => response.json())
      .then(data => {
          // handle the data
          const selectElement = document.querySelector('#category-select');
          data.forEach(category => {
              const optionElement = document.createElement('option');
              optionElement.value = category.id;
              optionElement.textContent = category.name;
              selectElement.appendChild(optionElement);
          });
      });
    </script>
    <div class="container">
      <button><a href="/html/admin/product_add.html">Add product</a></button>
      <table  class="table table-striped table-responsive-md" border="1" id="myTable" >
        <thead>
          <tr>
            <th>ID</th>
            <th>Image</th>
            <th>Product name</th>
            <th>Price</th>
            <th>Category</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="data">
          <!-- rows will be dynamically inserted here -->
        </tbody>
      </table>
    </div>
    <form width="100" id="update-form">
      <div>
        <input id="prdid" type="hidden"/>
      </div>
      <div class="null"></div>
      <div >
        <label>Tên mặt hàng </label>
        <input class="form-control mb-4 col-4" id="prdname" placeholder="Tên mặt hàng" type="text" required/>
      </div>
      <div class="null"></div>
      <div >
        <label>Mô tả</label>
        <input class="form-control mb-4 col-4" id="description" placeholder="Mô tả" type="text" required/>
      </div>
      <div class="null"></div>
      <div>
        <input type="file" class="inputFile" id="fileinp"onchange="getFile(event)"
        accept="image/*"/>
        <!-- <label for="fileinp" type="hidden">+</label>
        <span class="fileText" type="hidden"></span> -->
        <button onclick="uploadImage(event)" id="upbtn">Upload image</button>
        <div class="bar">
            <div class="process"></div>
        </div>
        <div class="uploadPercentage">0%</div>
        <div class="imageUploaded">
            <img width="200dp" height="200dp" alt="" class="img">
        </div>
      </div>
      
      <div class="null"></div>
      <div>
          <input class="form-control mb-4 col-4" id="price" placeholder="Giá" type="text" required/>
      </div>
      <div class="null"></div>
      <div>
          <label for="category-select">Select a category:</label>
          <select id="category-select"></select>
      </div>
      <div class="null"></div>
      <button id="update-btn" type="submit">Submit</button>
    </form>
    <script>
      const updateForm = document.getElementById('update-form');

      updateForm.addEventListener('submit', (event) => {
        // event.preventDefault(); // prevent the default form submission behavior
        
        const productId = document.getElementById('prdid').value;
        const prdName = document.getElementById('prdname').value;
        const description = document.getElementById('description').value;
        const imgPath = document.querySelector('.img').src; // assuming the img tag has a class of "img"
        const price = document.getElementById('price').value;
        const category = document.getElementById('category-select').value;
        
        const data = {
          id: productId,
          name: prdName,
          description: description,
          imgPath: imgPath,
          price: price,
          cate: {
            id: category
          }
        };
        
        fetch(`http://127.0.0.1:8080/api/v1/admin/products/${productId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
          // handle the API response data
          console.log(data);
        })
        .catch(error => {
          // handle the error
          console.error(error);
        });
      });

    </script>
    
    <script src="https://www.gstatic.com/firebasejs/6.0.2/firebase.js"></script>
    <script src="/js/fileservice.js"></script>
    <script href="/js/product.js"></script>
  </body>

</html>